name: Wake Up Supabase

on:
  schedule:
    - cron: "0 6 */3 * *"   # Runs once per day at 06:00 UTC
  workflow_dispatch:       # Allows manual runs from the Actions tab

jobs:
  ping-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Validate SUPABASE_PROJECTS_JSON secret exists
        run: |
          if [ -z "${{ secrets.SUPABASE_PROJECTS_JSON }}" ]; then
            echo "‚ùå Secret SUPABASE_PROJECTS_JSON is not set."
            echo "Go to Settings ‚Üí Secrets and variables ‚Üí Actions and add it."
            exit 1
          fi

      - name: Ping Supabase projects to keep them awake
        env:
          SUPABASE_PROJECTS_JSON: ${{ secrets.SUPABASE_PROJECTS_JSON }}
        run: |
          # Install jq for JSON parsing
          sudo apt-get update -y > /dev/null
          sudo apt-get install -y jq > /dev/null

          LENGTH=$(echo "$SUPABASE_PROJECTS_JSON" | jq '. | length')
          echo "üì¶ Found $LENGTH Supabase project(s)."

          if [ "$LENGTH" -eq 0 ]; then
            echo "‚ö†Ô∏è No projects defined in SUPABASE_PROJECTS_JSON."
            exit 0
          fi

          for i in $(seq 0 $((LENGTH - 1))); do
            URL=$(echo "$SUPABASE_PROJECTS_JSON" | jq -r ".[$i].url")
            KEY=$(echo "$SUPABASE_PROJECTS_JSON" | jq -r ".[$i].anon_key")

            if [ -z "$URL" ] || [ "$URL" = "null" ]; then
              echo "‚ö†Ô∏è Skipping project at index $i ‚Äî missing url."
              continue
            fi

            if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
              echo "‚ö†Ô∏è Skipping $URL ‚Äî missing anon_key."
              continue
            fi

            # Auth health endpoint ‚Äì always exists and is safe to call with anon key
            HEALTH_URL="${URL%/}/auth/v1/health"
            echo "üåê Pinging AUTH via: $HEALTH_URL"

            # Allow curl to fail without killing the whole job
            set +e
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "apikey: $KEY" \
              "$HEALTH_URL")
            CURL_EXIT=$?
            set -e

            if [ "$CURL_EXIT" -ne 0 ]; then
              echo "‚ùå Curl failed for $URL (exit code $CURL_EXIT). Skipping."
              continue
            fi

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ $URL responded with HTTP $HTTP_CODE ‚Äî project is reachable."
            else
              echo "‚ùå $URL responded with HTTP $HTTP_CODE ‚Äî check project status or URL."
            fi
          done
